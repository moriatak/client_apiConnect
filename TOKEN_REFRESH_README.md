# ××¢×¨×›×ª ×¨×¢× ×•×Ÿ ×˜×•×›×Ÿ ××•×˜×•××˜×™×ª

## ğŸ¯ ××˜×¨×”

×œ×× ×•×¢ ××”×©×¨×ª Node.js ×œ×§×‘×œ ×˜×•×›×Ÿ ×¤×’ ×ª×•×§×£ ×•×œ××¤×©×¨ ×œ××©×ª××© ×œ×”×©×ª××© ×‘××ª×¨ ×œ×œ× ×”×¤×¨×¢×•×ª.

## ğŸ”„ ××™×š ×–×” ×¢×•×‘×“?

### ×ª×”×œ×™×š ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™

1. **×‘×“×™×§×” ×›×œ 30 ×©× ×™×•×ª**
   - ×”××¢×¨×›×ª ×‘×•×“×§×ª ×›××” ×–××Ÿ × ×©××¨ ×¢×“ ×©×”×˜×•×›×Ÿ ×¤×’ ×ª×•×§×£
   - ××¦×™×’×” ×‘×§×•× ×¡×•×œ: `â° ×–××Ÿ ×¢×“ ×ª×¤×•×’×ª ×˜×•×›×Ÿ: X ×©× ×™×•×ª (Y ×“×§×•×ª)`

2. **×¨×¢× ×•×Ÿ ××•×˜×•××˜×™**
   - ×›××©×¨ × ×©××¨ **×¤×—×•×ª ××“×§×”** ×œ×¤× ×™ ×ª×¤×•×’×”
   - ×”××¢×¨×›×ª ×§×•×¨×××” ×œ-endpoint ×”×¨×¢× ×•×Ÿ **×‘××•×¤×Ÿ ×©×§×˜**
   - ×”×§×¨×™××” ×›×•×œ×œ×ª `credentials: 'include'` ×›×“×™ ×œ×©×œ×•×— cookies

3. **×¢×“×›×•×Ÿ ×˜×•×›×Ÿ**
   - ×”×˜×•×›×Ÿ ×”×—×“×© × ×©××¨ ××•×˜×•××˜×™×ª ×‘-memory
   - **×›×œ** ×”×‘×§×©×•×ª ×”×‘××•×ª ××©×ª××©×•×ª ×‘×˜×•×›×Ÿ ×”×—×“×©
   - ×”××©×ª××© **×œ× ××¨×’×™×©** ×©×§×¨×” ××©×”×•!

4. **×˜×™×¤×•×œ ×‘×›×©×œ×•×Ÿ**
   - ×× ×”×¡×©×Ÿ ×‘×¤×•×¨×˜×œ ×¤×’ ×ª×•×§×£ (401)
   - ×”××¢×¨×›×ª ×× ×ª×§×ª ××ª ×”××©×ª××©
   - ××¦×™×’×” ××¡×š ×©×’×™××”: "×”×¡×©×Ÿ ×¤×’ ×ª×•×§×£. ×× × ×”×ª×—×‘×¨ ××—×“×© ×“×¨×š ×”×¤×•×¨×˜×œ"

## ğŸ“¡ Refresh Token Endpoint

### URL
```
https://portal.tak.co.il/pages/admin_page/manage_api_apps/refresh_token.php
```

### Request
```http
POST /pages/admin_page/manage_api_apps/refresh_token.php HTTP/1.1
Host: portal.tak.co.il
Content-Type: application/json
Cookie: admin_company=62; admin_id=1203
```

**×—×©×•×‘**: ×”×‘×§×©×” ×—×™×™×‘×ª ×œ×›×œ×•×œ `credentials: 'include'` ×›×“×™ ×œ×©×œ×•×— ××ª ×”-cookies!

### Response - ×”×¦×œ×—×” âœ…
```json
{
  "success": true,
  "token": "eyJ1c2VyIjoxMjAzLCJjb21wYW55Ijo2Mn0.a7f8d9e1b2c3d4e5f6g7h8i9j0k1l2m3",
  "expiresAt": 1735663600
}
```

- **token**: ×”×˜×•×›×Ÿ ×”×—×“×© (×‘××•×ª×• ×¤×•×¨××˜ `payload.signature`)
- **expiresAt**: ×ª××¨×™×š ×ª×¤×•×’×” ×‘-Unix timestamp (×©× ×™×•×ª)

### Response - ×›×©×œ×•×Ÿ âŒ
```json
{
  "error": "Session expired",
  "message": "User is not logged in"
}
```

**××ª×™ ×–×” ×§×•×¨×”?**
- ×”×¢×•×’×™×•×ª `admin_company` ××• `admin_id` ×œ× ×§×™×™××•×ª
- ×”××©×ª××© ×”×ª× ×ª×§ ××”×¤×•×¨×˜×œ
- ×”×¡×©×Ÿ ×©×œ ×”×¤×•×¨×˜×œ ×¤×’ ×ª×•×§×£

## ğŸ” ××” ×§×•×¨×” ×‘×¨×§×¢?

### Timeline ×“×•×’××”

```
â° 00:00 - ××©×ª××© × ×›× ×¡ ×¢× ×˜×•×›×Ÿ ×©×¤×’ ×‘-00:02 (×“×§×ª×™×™×)
â° 00:30 - ×‘×“×™×§×”: × ×©××¨ 90 ×©× ×™×•×ª â†’ ××™×Ÿ ×¦×•×¨×š ×‘×¨×¢× ×•×Ÿ
â° 01:00 - ×‘×“×™×§×”: × ×©××¨ 60 ×©× ×™×•×ª â†’ ××™×Ÿ ×¦×•×¨×š ×‘×¨×¢× ×•×Ÿ
â° 01:30 - ×‘×“×™×§×”: × ×©××¨ 30 ×©× ×™×•×ª â†’ ××¨×¢× ×Ÿ ×˜×•×›×Ÿ!
ğŸ”„ 01:30 - ×§×•×¨× ×œ-refresh endpoint
âœ… 01:31 - ××§×‘×œ ×˜×•×›×Ÿ ×—×“×© ×©×¤×’ ×‘-03:31 (×“×§×ª×™×™× ×—×“×©×•×ª)
â° 02:00 - ×‘×“×™×§×”: × ×©××¨ 91 ×©× ×™×•×ª â†’ ××™×Ÿ ×¦×•×¨×š ×‘×¨×¢× ×•×Ÿ
... ×”×ª×”×œ×™×š ×—×•×–×¨ ×¢×œ ×¢×¦××•
```

## ğŸ“Š ×œ×•×’×™× ×‘×§×•× ×¡×•×œ

### ×‘×“×™×§×” ×¨×’×™×œ×”
```
â° ×–××Ÿ ×¢×“ ×ª×¤×•×’×ª ×˜×•×›×Ÿ: 120 ×©× ×™×•×ª (2 ×“×§×•×ª)
```

### ×¨×¢× ×•×Ÿ ×˜×•×›×Ÿ
```
â° ×–××Ÿ ×¢×“ ×ª×¤×•×’×ª ×˜×•×›×Ÿ: 45 ×©× ×™×•×ª (0 ×“×§×•×ª)
âš ï¸ ×˜×•×›×Ÿ ×§×¨×•×‘ ×œ×¤×•×’ ×ª×•×§×£ - ××¨×¢× ×Ÿ ×¢×›×©×™×•
ğŸ”„ ×× ×¡×” ×œ×¨×¢× ×Ÿ ×˜×•×›×Ÿ...
âœ… ×˜×•×›×Ÿ ×¨×•×¢× ×Ÿ ×‘×”×¦×œ×—×”
ğŸ†• ×˜×•×›×Ÿ ×—×“×© ×¤×’ ×ª×•×§×£ ×‘: 31.12.2025, 13:40:00
```

### ×›×™×©×œ×•×Ÿ - ×¡×©×Ÿ ×¤×’
```
â° ×–××Ÿ ×¢×“ ×ª×¤×•×’×ª ×˜×•×›×Ÿ: 30 ×©× ×™×•×ª (0 ×“×§×•×ª)
âš ï¸ ×˜×•×›×Ÿ ×§×¨×•×‘ ×œ×¤×•×’ ×ª×•×§×£ - ××¨×¢× ×Ÿ ×¢×›×©×™×•
ğŸ”„ ×× ×¡×” ×œ×¨×¢× ×Ÿ ×˜×•×›×Ÿ...
âŒ ×¨×¢× ×•×Ÿ ×˜×•×›×Ÿ × ×›×©×œ: Session expired
âŒ ×”×¡×©×Ÿ ×‘×¤×•×¨×˜×œ ×¤×’ ×ª×•×§×£ - ×× ×ª×§ ××©×ª××©
```

## ğŸ› ï¸ ×§×‘×¦×™× ×©×¢×•×“×›× ×•

### 1. `src/contexts/AuthContext.jsx`

**××” × ×•×¡×£:**
- ×¤×•× ×§×¦×™×” `refreshToken()` - ×§×•×¨××ª ×œ-endpoint ×•××¢×“×›× ×ª ×˜×•×›×Ÿ
- ×¤×•× ×§×¦×™×” `checkAndRefreshToken()` - ×‘×•×“×§×ª ×× ×¦×¨×™×š ×œ×¨×¢× ×Ÿ
- `setInterval` - ×‘×•×“×§ ×›×œ 30 ×©× ×™×•×ª

**××™×š ×–×” ×¢×•×‘×“:**
```javascript
// ×‘×“×™×§×” ×›×œ 30 ×©× ×™×•×ª
const refreshInterval = setInterval(() => {
  const currentExpiresAt = auth.getExpiresAt();
  const timeUntilExpiry = currentExpiresAt - now;

  // ×× × ×©××¨ ×¤×—×•×ª ××“×§×”
  if (timeUntilExpiry < 60) {
    refreshToken(); // ×¨×¢× ×Ÿ ×˜×•×›×Ÿ
  }
}, 30000);
```

### 2. `src/utils/auth.js`

**××” × ×•×¡×£:**
- `getExpiresAt()` - ××—×–×™×¨ ××ª ×ª××¨×™×š ×ª×¤×•×’×ª ×”×˜×•×›×Ÿ

## ğŸ›ï¸ ×”×’×“×¨×•×ª

### ×–××Ÿ ×‘×“×™×§×”
×‘×¨×™×¨×ª ××—×“×œ: **30 ×©× ×™×•×ª**

×›×“×™ ×œ×©× ×•×ª, ×¢×¨×•×š ××ª `AuthContext.jsx`:
```javascript
const refreshInterval = setInterval(() => {
  checkAndRefreshToken();
}, 30000); // ×©× ×” ×œ-60000 ×œ×“×§×”, 15000 ×œ-15 ×©× ×™×•×ª ×•×›×•'
```

### Threshold ×œ×¨×¢× ×•×Ÿ
×‘×¨×™×¨×ª ××—×“×œ: **60 ×©× ×™×•×ª (×“×§×”)**

×›×“×™ ×œ×©× ×•×ª:
```javascript
if (timeUntilExpiry < 60) { // ×©× ×” ×œ-120 ×œ×“×§×ª×™×™×, 30 ×œ-30 ×©× ×™×•×ª ×•×›×•'
  refreshToken();
}
```

## ğŸ§ª ×‘×“×™×§×”

### ×ª×¨×—×™×© 1: ×¨×¢× ×•×Ÿ ××•×¦×œ×—
1. ×”×™×›× ×¡ ×œ××ª×¨ ×“×¨×š ×”×¤×•×¨×˜×œ
2. ×¤×ª×— ×§×•× ×¡×•×œ (F12)
3. ×—×›×” ×¢×“ ×©×”×˜×•×›×Ÿ ×§×¨×•×‘ ×œ×¤×•×’ (××• ×©× ×” ××ª ×”-threshold)
4. ×¦×¤×•×™ ×œ×¨××•×ª:
   ```
   âš ï¸ ×˜×•×›×Ÿ ×§×¨×•×‘ ×œ×¤×•×’ ×ª×•×§×£ - ××¨×¢× ×Ÿ ×¢×›×©×™×•
   ğŸ”„ ×× ×¡×” ×œ×¨×¢× ×Ÿ ×˜×•×›×Ÿ...
   âœ… ×˜×•×›×Ÿ ×¨×•×¢× ×Ÿ ×‘×”×¦×œ×—×”
   ```

### ×ª×¨×—×™×© 2: ×¡×©×Ÿ ×¤×’ ×‘×¤×•×¨×˜×œ
1. ×”×™×›× ×¡ ×œ××ª×¨ ×“×¨×š ×”×¤×•×¨×˜×œ
2. **×”×ª× ×ª×§** ××”×¤×•×¨×˜×œ (××• ××—×§ cookies)
3. ×—×›×” ×¢×“ ×©×”×˜×•×›×Ÿ ×§×¨×•×‘ ×œ×¤×•×’
4. ×¦×¤×•×™ ×œ×¨××•×ª:
   ```
   âŒ ×¨×¢× ×•×Ÿ ×˜×•×›×Ÿ × ×›×©×œ
   âŒ ×”×¡×©×Ÿ ×‘×¤×•×¨×˜×œ ×¤×’ ×ª×•×§×£ - ×× ×ª×§ ××©×ª××©
   ```
5. ×¦×¤×•×™ ××¡×š ×©×’×™××” ××“×•×: "×”×¡×©×Ÿ ×¤×’ ×ª×•×§×£. ×× × ×”×ª×—×‘×¨ ××—×“×© ×“×¨×š ×”×¤×•×¨×˜×œ"

### ×ª×¨×—×™×© 3: ×©×™××•×© ×¨×’×™×œ
1. ×”×™×›× ×¡ ×œ××ª×¨ ×“×¨×š ×”×¤×•×¨×˜×œ
2. ×¢×‘×•×“ ×‘××ª×¨ ×œ×›××” ×“×§×•×ª
3. ×”×˜×•×›×Ÿ ×××•×¨ ×œ×”×ª×¨×¢× ×Ÿ **××•×˜×•××˜×™×ª** ×‘×¨×§×¢
4. ×”××©×ª××© **×œ× ×××•×¨ ×œ×”×¨×’×™×©** ×©×§×•×¨×” ××©×”×•

## ğŸ”’ ××‘×˜×—×”

### CORS
×”-endpoint ×—×™×™×‘ ×œ××¤×©×¨ ×‘×§×©×•×ª ××”×“×•××™×™×Ÿ ×©×œ ×”××¤×œ×™×§×¦×™×”:
```php
// ×‘×¦×“ ×”×©×¨×ª
header('Access-Control-Allow-Origin: https://tak.co.il');
header('Access-Control-Allow-Credentials: true');
```

### Cookies
×”×‘×§×©×” **×—×™×™×‘×ª** ×œ×›×œ×•×œ:
```javascript
credentials: 'include'
```

×–×” ×©×•×œ×— ××ª ×”-cookies `admin_company` ×•-`admin_id` ×œ×©×¨×ª.

### HTTPS
×›×œ ×”×ª×”×œ×™×š **×—×™×™×‘** ×œ×¢×‘×•×“ ×¢×œ HTTPS!

## âš ï¸ ×‘×¢×™×•×ª × ×¤×•×¦×•×ª

### ×”×˜×•×›×Ÿ ×œ× ××ª×¨×¢× ×Ÿ
**×‘×“×•×§**:
1. ×”×× ×™×© ×©×’×™××•×ª ×‘×§×•× ×¡×•×œ?
2. ×”×× ×”-endpoint ××—×–×™×¨ 200 OK ×‘-Network tab?
3. ×”×× ×”-cookies × ×©×œ×—×™× (×‘×“×•×§ ×‘-Request Headers)?

### ×”×©×¨×ª ××—×–×™×¨ 401
**×¡×™×‘×•×ª ××¤×©×¨×™×•×ª**:
1. ×”××©×ª××© ×”×ª× ×ª×§ ××”×¤×•×¨×˜×œ
2. ×”-cookies ×œ× × ×©×œ×—×™× (CORS?)
3. ×”×¡×©×Ÿ ×‘×¤×•×¨×˜×œ ×¤×’ ×ª×•×§×£

### ×”×˜×•×›×Ÿ ××ª×¨×¢× ×Ÿ ××‘×œ ×”×‘×§×©×•×ª × ×›×©×œ×•×ª
**×‘×“×•×§**:
1. ×”×× ×”×˜×•×›×Ÿ ×”×—×“×© × ×©××¨ ×‘-`auth` utility?
2. ×‘×“×•×§ ×‘-Network tab ×× ×™×© `Authorization: Bearer {new_token}`

## ğŸ’¡ ×˜×™×¤×™×

1. **×¢×§×•×‘ ××—×¨×™ ×”×œ×•×’×™×** - ×”× ×™×’×™×“×• ×œ×š ×‘×“×™×•×§ ××” ×§×•×¨×”
2. **×‘×“×•×§ ×‘-Network tab** - ×ª×¨××” ××ª ×”×‘×§×©×” ×œ-refresh endpoint
3. **××œ ×ª×©× ×” ××ª ×”-threshold** ×œ×¤×—×•×ª ×-30 ×©× ×™×•×ª - ×¢×œ×•×œ ×œ×™×¦×•×¨ ×‘×¢×™×•×ª
4. **×•×“× ×©-CORS ××•×’×“×¨ × ×›×•×Ÿ** ×‘×©×¨×ª

---

**×¢×“×›×•×Ÿ ××—×¨×•×Ÿ**: 2026-01-01
**×’×¨×¡×”**: 1.0
